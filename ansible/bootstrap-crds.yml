---
- hosts: masters[0]
  become: yes
  become_user: root
  tasks:
    - name: Create CRD folders
      file:
        path: "/etc/kubeadm/{{ item }}"
        state: directory
      with_lines: cat {{crd_file_path}} | xargs dirname | uniq

    - name: Upload CRDs
      copy:
        src: "../crds/{{ item }}"
        dest: /etc/kubeadm/{{ item }}
      with_lines: cat {{crd_file_path}}

    - name: Bootstrap CRDs
      command: kubectl --kubeconfig /etc/kubernetes/admin.conf apply -f {{ item }}
      args:
        chdir: '/etc/kubeadm'
      with_lines: cat {{crd_file_path}}
