<h1>Kubernetes dashboard with dex and oauth2 with Google as a provider</h1>

This is a example how to set up Kubernetes dashboard with dex and oauth with Google as a provider on the system services cluster.

Note: The files gen-rke-conf-ss, oauth2-proxy-values.yaml and dex-values.yaml has to be looked over when letsencrypt is working.

Node: Atm deploy-ss script deploys dex, oauth2 and dashboard, should be moved to correct clusters.

<h3>Important files</h3>
{project root}/helm-values/dex-values.yaml

{project root}/oauth2-proxy-values.yaml
{project root}/scripts/deploy-ss.sh
{project root}/scripts/gen-rke-conf-ss.sh

<h2>Deploy</h2>

1. Follow the [these steps](https://bitbucket.org/elastisys/a1-demo/src/master/terraform/) for setting up the machines with terraform

2. Set up dns for dex and dashboard
Example url for dex (https://dex.example.com)
Atm the e_ip is not working, use worker node ips instead.

3. Edit configure files to match correct dex issuer domain
3.1 Edit gen-rke-conf-ss
    The api-server expects a url to the oidc-issuer-url. Update the field <i>oidc-issuer-url</i> to match the correct url for dex.

    The api-server expects a CA for dex aswell and if letsencyrpt is not being used a CA certificate has to be provided. Go to Manuel provision of CA file.
3.2 Edit dex-values 
    Edit fields hosts and issuer to match correct url for dex. 
3.3 Edit oauth2-proxy-values
    Edit fields hosts and oidc-issuer-url to match correct url for dex.
    
4. Google client-key and secret for dex

Go to google cloud platform and create a project. Select Api and credentials under the menu.

Select Oauth consent screen and add the top level domain to Authorized domains. (example.com) 

Under Credentials select services -> Credentials and create a <i>new ouath client ID</i> under create credentials. 

Select <i>web application</i> and select a name and add url for dex as  Authorized Javascript origins and add < dex url >/callback to Authorized redirect URIs. Example (https://dex.example.com) and (https://dex.example.com/callback)

Next step is to take the client id and client secret generated by Google and add them to dex-values.yaml. Edit fields clientID and clientSecret.

5. Rke setup

        ./scripts/gen-rke-conf-ss.sh > ./eck-ss.yaml

        rke up --config ./eck-ss.yaml

If rke fails because it was unable to find the CA file that is required for dex. Then a CA file has to be provided manually to the master node. Go to Manuel provision of CA file

6. Set up kubectl

        export ECK_DOMAIN=a1demo.compliantk8s.com

        export KUBECONFIG=$(pwd)/kube_config_eck-ss.yaml

If manuel provision of a CA file was done a secret has to be created with the cert and key. Go to Manuel secret for dex.

7. Run deploy script

        ./deploy-ss.sh
 

<h2>Manuel provision of CA file</h2>

The CA file has to be mounted in a location where the the api-server can find it. To know where to put the CA file follow these steps.

First create the certificates with the script.

        ./gencret.sh

First SSH to the the master node by executing the following command

        exo ssh <name of master node>

Next find out what id the api-server has by using the following command

        docker ps

This will output a list of docker images. Use the container id for the api-server in the following command

    docker inspect <container id>

This will output a long list of config values for the api-server. Find the configure for "Mounts".

    "Mounts": [     
         ...
         {
            "Type": "bind",
            "Source": "/opt/rke/etc/kubernetes",
            "Destination": "/etc/kubernetes",
            "Mode": "z",
            "RW": true,
            "Propagation": "rprivate"
        }
    ],
<i>Example output for a api-server image</i>

The example above shows that the api-server will mount the folder <i>/opt/rke/etc/kubernetes</i> to <i>/etc/kubernetes</i>. In this example there will be a folder <i>/etc/kubernetes/ssl</i> where all of the api-servers pem files will be stored.

Now update the field <i>oidc-ca-file</i> in the <i>gen-rke-conf-ss</i> script to match the destination folder and the name of the CA file.

    ...
        extra_args:
            oidc-issuer-url: https://dex.compliantk8s.com
            oidc-client-id: test-app
            oidc-ca-file: /etc/kubernetes/ssl/dex-ca.pem
            oidc-username-claim: email
            oidc-groups-claim: groups
    ...

Next step is to send the generated CA certificate, <i>ca.pem</i>, to the server and move it to the source folder which will be mounted by the api-server.

<h2>Manuel secret for dex</h2>

When creating the secret it is important to have the correct namespace. Dex is running under the namespace of Dex.

The following command is a example how to crate a secret for dex. Dex expects a secret with the name of dex-tls in the namespace dex.

        kubectl create namespace dex

        kubectl create secret tls dex-tls --cert=./ssl/cert.pem --key=./ssl/key.pem -n dex



* Added 
    * kubectl apply -f ... to gen-rke-conf-c.sh
* Added psp rules for kubernetes-dashboard to 
    * psp-access.yaml
* Set up Dex according to README
* Looking for information how to auth with dex and ouath2 for dashboard.
    * <b>kubernetes-dashboard</b>: Kubeconfig Authentication method does not support external identity providers or certificate-based authentication.
    * https://blog.inkubate.io/access-your-kubernetes-cluster-with-your-active-directory-credentials/
    * https://thenewstack.io/single-sign-on-for-kubernetes-dashboard-experience/
    

https://github.com/dexidp/dex/blob/master/Documentation/kubernetes.md

1. Sätt false i deployment för web dex/values.yaml
2. Skapa openssl för att skapa manuella cert för dex (finns scripts på sidan)
3. Skapa generic secrets med rätt namn för dem skapa certificaten dex/templates/deployment
4. sätt rätt mountpath i gen-rke-conf-ss.sh

dag två:
0. Skapade ca filerna med hjälp av script som följde med dex repot (behövs när letsencypt inte funkar)
0.1 byte dns.1 till dex.compliantk8s.com
1. Skriv in var ca filen är för api-server på rätt stäle (behövs när letsencypt inte funkar)
1.1 ssh in på master
1.2 docker ps för att se alla images
1.3 docker inspect <id för kube-apiserver>
1.4 leta efter mount och se var man kan lägga CA filen.
1.5 skriv in ca path på ett ställe som api-server mountar
2. skickar över ca filen till master noden
2.1 flyttar ca filen till rätt path
3. skrev om i dex-values 
3.1 tog bort letsencrypt (lägg till backa när letsencrypt funkar)
3.2 byte host över alt till dex.compliantk8s.com
3.3 byte namn på secret name till dex-tls
4. skapade och körde igång rke
5. körde igång deploy-ss script
5.1 lagt till dex upgrade i deploy scriptet
5.2 lagt till oauth2 i deploy scriptet
5.3 lagt till dashboard i deploy scriptet
6. tog bort cert-manager (behövs vara när letsencypt inte funkar)
6.1 service och deployment
6.2 tog bort secret under dex namespace
7. skapade secret med hjälp av kubectl med rätt namespace (behövs när letsencypt inte funkar)
8. make och köra exemple server från dex 
9. Depoly oauth2 och dashboard
10. Lagt till worker ip i dns i stället för eip (ta bort när letsencrypt funkar?)
11. Lagt till ssl-insecure-skip-verify: true i oauth2 config (ta bort när letsencrypt funkar)
12. Updated Authorized domains för compliantk8s.com
13. skapade en ny oauth2 client för web application
14. byte namn på apllication name till samma som project name (vänta ett tag för det att komma genom systemet)

komandon:
kubectl create secret tls dex-tls --cert=../examples/k8s/ssl/cert.pem --key=../examples/k8s/ssl/key.pem -n dex
kubectl run curl-robin --image=radial/busyboxplus:curl -i --tty --rm


https://github.com/dexidp/dex/blob/master/Documentation/connectors/oidc.md
https://github.com/dexidp/dex/blob/master/Documentation/kubernetes.md
https://thenewstack.io/single-sign-on-for-kubernetes-dashboard-experience/
https://stackoverflow.com/questions/11485271/google-oauth-2-authorization-error-redirect-uri-mismatch



