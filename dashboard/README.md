##Kubernetes dashboard with dex and oauth2 with Google as a provider

This is a example how to set up Kubernetes dashboard with dex and oauth with Google as a provider on the system services cluster and a dashboard for customer that authenticates towards system service dex.

####Important files
* {project root}/helm-values/dex-values.yaml
* {project root}/helm-values/oauth2-proxy-values.yaml
* {project root}/helm-values/oauth2-proxy-values-c.yaml
* {project root}/scripts/deploy-ss.sh
* {project root}/scripts/deploy-c.sh
* {project root}/scripts/gen-rke-conf-ss.sh
* {project root}/scripts/gen-rke-conf-c.sh

###Deploy

1. Follow [these steps](https://bitbucket.org/elastisys/a1-demo/src/master/terraform/) for setting up the machines with terraform.

2. **Set up dns for dex and dashboard**

Example url for dex (https://dex.example.com)
Example url for dashboard for system service cluster (https://dashboard.example.com)
Example url for dashboard for customer cluster (https://dashboard.customer.example.com)
Atm the e_ip is not working, use worker node ips instead.

3. **Set environment variables**

Set the following environment variables to the top level domains for system service and customer  
                
        export ECK_DOMAIN=example.com

        export ECK_C_DOMAIN=customer.example.com
    
5. **Google client-key and secret for dex**

**Note:** If google is being used as a isuer.

Go to google cloud platform and create a project. Select Api and credentials under the menu.

Select Oauth consent screen and name the application with the same name as the project of your google cloud project add the top level domain to Authorized domains (example.com). 

Under Credentials select services -> Credentials and create a *new ouath client ID* under create credentials. Select *web application* and select a name and add url for dex as  Authorized Javascript origins and add < dex url >/callback to Authorized redirect URIs. Example (https://dex.example.com) and (https://dex.example.com/callback)

Next step is to take the client id and client secret generated by Google and add them to dex-values.yaml. Edit fields clientID and clientSecret.

6. **Rke setup**

        ./scripts/gen-rke-conf-ss.sh > ./eck-ss.yaml
        rke up --config ./eck-ss.yaml

        ./scripts/gen-rke-conf-c.sh > ./eck-c.yaml
        rke up --config ./eck-c.yaml

7. **Deploy**

        export ECK_DOMAIN=a1demo.compliantk8s.com

        export KUBECONFIG=$(pwd)/kube_config_eck-ss.yaml
        ./deploy-ss.sh

        export ECK_SS_KUBECONFIG=$(pwd)/kube_config_eck-ss.yaml
        export KUBECONFIG=$(pwd)/kube_config_eck-c.yaml
        ./scripts/deploy-c.sh    
        
8. **Give permissions to admin@example.com**

        kubectl apply -f ./manifests/rbac.yaml