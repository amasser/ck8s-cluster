<h1>Kubernetes dashboard with dex and oauth2 with Google as a provider</h1>

This is a example how to set up Kubernetes dashboard with dex and oauth with Google as a provider on the system services cluster and a dashboard for customer that authenticates towards system service dex.

<b>Note:</b> The files gen-rke-conf-ss, oauth2-proxy-values.yaml and dex-values.yaml has to be updated when letsencrypt works.

<h3>Important files</h3>
{project root}/helm-values/dex-values.yaml

{project root}/helm-values/oauth2-proxy-values.yaml
{project root}/helm-values/oauth2-proxy-values-c.yaml
{project root}/helm-values/dex.yaml
{project root}/scripts/deploy-ss.sh
{project root}/scripts/deploy-c.sh
{project root}/scripts/gen-rke-conf-ss.sh
{project root}/scripts/gen-rke-conf-c.sh

<h2>Deploy</h2>

1. Follow the [these steps](https://bitbucket.org/elastisys/a1-demo/src/master/terraform/) for setting up the machines with terraform.

2. <b>Set up dns for dex and dashboard</b>
Example url for dex (https://dex.example.com)
Example url for dashboard for system service cluster (https://dashboard.example.com)
Example url for dashboard for customer cluster (https://dashboard-customer.example.com)
Atm the e_ip is not working, use worker node ips instead.

3. <b>Edit configure files to match correct dex issuer domain</b>
3.1 <b>Edit gen-rke-conf-ss</b>
    The api-server expects a url to the oidc-issuer-url. Update the field <i>oidc-issuer-url</i> to match the correct url for dex.

    <b>Note:</b> The api-server expects a CA for dex aswell and if letsencyrpt is not being used a CA certificate has to be provided for both clusters. Go to Manuel provision of CA file. 
3.2 <b>Edit dex-values </b>
    Edit fields hosts and issuer to match correct url for dex.
    Edit staticClients redirectURIs to match the dashbaords. 
3.3 <b>Edit oauth2-proxy-values</b>
    Edit fields hosts and oidc-issuer-url to match correct url for dex.
    
4. <b>Google client-key and secret for dex</b>

Go to google cloud platform and create a project. Select Api and credentials under the menu.

Select Oauth consent screen and name the application with the same name as the project of your google cloud project add the top level domain to Authorized domains (example.com). 

Under Credentials select services -> Credentials and create a <i>new ouath client ID</i> under create credentials. Select <i>web application</i> and select a name and add url for dex as  Authorized Javascript origins and add < dex url >/callback to Authorized redirect URIs. Example (https://dex.example.com) and (https://dex.example.com/callback)

Next step is to take the client id and client secret generated by Google and add them to dex-values.yaml. Edit fields clientID and clientSecret.

5. <b>Rke setup</b>

        ./scripts/gen-rke-conf-ss.sh > ./eck-ss.yaml
        rke up --config ./eck-ss.yaml

        ./scripts/gen-rke-conf-c.sh > ./eck-c.yaml
        rke up --config ./eck-c.yaml

If rke fails because it was unable to find the CA file that is required for dex. Then a CA file has to be provided manually to the master node. Go to Manuel provision of CA file

6. <b>Deploy</b>
If manuel provision of a CA file was done a secret has to be created with the cert and key for the system service cluster. Go to Manuel secret for dex.

        export ECK_DOMAIN=a1demo.compliantk8s.com

        export KUBECONFIG=$(pwd)/kube_config_eck-ss.yaml
        ./deploy-ss.sh

        export ECK_SS_KUBECONFIG=$(pwd)/kube_config_eck-ss.yaml
        export KUBECONFIG=$(pwd)/kube_config_eck-c.yaml
        ./scripts/deploy-c.sh    

<h2>Manuel provision of CA file</h2>

The CA file has to be mounted in a location where the the api-server can find it. To know where to put the CA file follow these steps.

First create the certificates with the script.

        ./gencret.sh

First SSH to the the master node by executing the following command

        exo ssh <name of master node>

Next find out what id the api-server has by using the following command

        docker ps

This will output a list of docker images. Use the container id for the api-server in the following command

    docker inspect <container id>

This will output a long list of config values for the api-server. Find the configure for "Mounts".

    "Mounts": [     
         ...
         {
            "Type": "bind",
            "Source": "/opt/rke/etc/kubernetes",
            "Destination": "/etc/kubernetes",
            "Mode": "z",
            "RW": true,
            "Propagation": "rprivate"
        }
    ],
<i>Example output for a api-server image</i>

The example above shows that the api-server will mount the folder <i>/opt/rke/etc/kubernetes</i> to <i>/etc/kubernetes</i>. In this example there will be a folder <i>/etc/kubernetes/ssl</i> where all of the api-servers pem files will be stored.

Now update the field <i>oidc-ca-file</i> in the <i>gen-rke-conf-ss</i> script to match the destination folder and the name of the CA file.

    ...
        extra_args:
            oidc-issuer-url: https://dex.compliantk8s.com
            oidc-client-id: test-app
            oidc-ca-file: /etc/kubernetes/ssl/dex-ca.pem
            oidc-username-claim: email
            oidc-groups-claim: groups
    ...

Next step is to send the generated CA certificate, <i>ca.pem</i>, to the server and move it to the source folder which will be mounted by the api-server.

<h2>Manuel secret for dex</h2>

When creating the secret it is important to have the correct namespace. Dex is running under the namespace of Dex.

The following command is a example how to create a secret for dex. Dex expects a secret with the name of dex-tls in the namespace dex.

        kubectl create namespace dex

        kubectl create secret tls dex-tls --cert=./ssl/cert.pem --key=./ssl/key.pem -n dex