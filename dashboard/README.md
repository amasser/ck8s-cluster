##Kubernetes dashboard with dex and oauth2 with Google as a provider

This is a example how to set up Kubernetes dashboard with dex and oauth with Google as a provider on the system services cluster and a dashboard for customer that authenticates towards system service dex.

**Note:** The files **gen-rke-conf-ss**, **oauth2-proxy-values.yaml**, **oauth2-proxy-values-c.yaml** and **dex-values.yaml** has to be updated when letsencrypt works.

####Important files
* {project root}/helm-values/dex-values.yaml
* {project root}/helm-values/oauth2-proxy-values.yaml
* {project root}/helm-values/oauth2-proxy-values-c.yaml
* {project root}/scripts/deploy-ss.sh
* {project root}/scripts/deploy-c.sh
* {project root}/scripts/gen-rke-conf-ss.sh
* {project root}/scripts/gen-rke-conf-c.sh

###Deploy
1. Run gencert script

If letencrypt is not being used run gencert scrit under dashboard

       {project root}/dashboard/gencert.sh 

This will generate certificates for the hostname dex.compliantk8s.com. To change the hostname edit the script and change the value for DNS.1


2. Follow [these steps](https://bitbucket.org/elastisys/a1-demo/src/master/terraform/) for setting up the machines with terraform.

3. **Set up dns for dex and dashboard**

Example url for dex (https://dex.example.com)
Example url for dashboard for system service cluster (https://dashboard.example.com)
Example url for dashboard for customer cluster (https://dashboard-customer.example.com)
Atm the e_ip is not working, use worker node ips instead.

4. **Edit configure files to match correct dex issuer domain**

   1.  **Edit gen-rke-conf-ss**

        The api-server expects a url to the oidc-issuer-url. Update the field *oidc-issuer-url* to match the correct url for dex.

        **Note:** Because letsencrypt is not working atm the api-server expects a CA for dex aswell. The CA file is provided automatically in step 2.

    2. **Edit dex-values**

        Edit fields hosts and issuer to match correct url for dex. Edit staticClients redirectURIs to match the dashbaords.

   3. **Edit oauth2-proxy-values**

        Edit fields hosts and oidc-issuer-url to match correct url for dex.
    
5. **Google client-key and secret for dex**

**Note:** If google is being used as a isuer.

Go to google cloud platform and create a project. Select Api and credentials under the menu.

Select Oauth consent screen and name the application with the same name as the project of your google cloud project add the top level domain to Authorized domains (example.com). 

Under Credentials select services -> Credentials and create a *new ouath client ID* under create credentials. Select *web application* and select a name and add url for dex as  Authorized Javascript origins and add < dex url >/callback to Authorized redirect URIs. Example (https://dex.example.com) and (https://dex.example.com/callback)

Next step is to take the client id and client secret generated by Google and add them to dex-values.yaml. Edit fields clientID and clientSecret.

6. **Rke setup**

        ./scripts/gen-rke-conf-ss.sh > ./eck-ss.yaml
        rke up --config ./eck-ss.yaml

        ./scripts/gen-rke-conf-c.sh > ./eck-c.yaml
        rke up --config ./eck-c.yaml

If rke fails because it was unable to find the CA file that is required for dex. Then a CA file has to be provided manually to the master node. Go to Manuel provision of CA file

7. **Deploy**

If manuel provision of a CA file was done a secret has to be created with the cert and key for the system service cluster. Go to Manuel secret for dex.

        export ECK_DOMAIN=a1demo.compliantk8s.com

        export KUBECONFIG=$(pwd)/kube_config_eck-ss.yaml
        ./deploy-ss.sh

        export ECK_SS_KUBECONFIG=$(pwd)/kube_config_eck-ss.yaml
        export KUBECONFIG=$(pwd)/kube_config_eck-c.yaml
        ./scripts/deploy-c.sh    
8. **Give permissions to admin@example.com**

        kubectl apply -f ./manifests/rbac.yaml